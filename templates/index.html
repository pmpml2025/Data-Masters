<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center">Data Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dataTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#reports">Reports Generation</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#database">Database Management</a>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- Reports Generation Tab -->
        <div class="tab-pane fade show active" id="reports">
            <h4>Download Reports</h4>
            <ul class="list-group mb-3">
                <li class="list-group-item">Monthly Depotwise Operation Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('monthly_depotwise')">Download</button></li>
                <li class="list-group-item">Areawise Operation Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('areawise_operation')">Download</button></li>
                <li class="list-group-item">Service Type wise Operation Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('service_typewise')">Download</button></li>
                <li class="list-group-item">Depotwise Bus Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('depotwise_bus')">Download</button></li>
                <li class="list-group-item">Overall Stop Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('overall_stop')">Download</button></li>
                <li class="list-group-item">Service area wise Stop Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('service_area_stop')">Download</button></li>
                <li class="list-group-item">BRT Corridor Details & Corridor wise route Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('brt_corridor')">Download</button></li>
                <li class="list-group-item">Schedulewise Kilometer, Revenue Details <button class="btn btn-sm btn-primary float-end" onclick="downloadReport('schedulewise_km_revenue')">Download</button></li>
            </ul>
        </div>
        
        <!-- Database Management Tab -->
        <div class="tab-pane fade" id="database">
            <h4>Download Sample Excel</h4>
            <select id="downloadTableSelect" class="form-select mb-3">
                <option selected disabled>Choose a table</option>
            </select>
            <button class="btn btn-info" onclick="downloadSample()">Download</button>
            
            <h4 class="mt-4">Upload Excel File</h4>
            <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
                <select id="uploadTableSelect" name="table" class="form-select mb-3">
                    <option selected disabled>Choose a table</option>
                </select>
                <input type="file" id="fileInput" name="file" class="form-control" required>
                <button type="submit" class="btn btn-primary mt-2">Upload</button>
            </form>
            <div id="progress" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Uploading...</span>
                </div>
                <p>Uploading...</p>
            </div>
            
            <h4 class="mt-4">View Table Data</h4>
            <select id="tableSelect" class="form-select mb-3">
                <option selected disabled>Choose a table</option>
            </select>
            <button class="btn btn-success" onclick="fetchTableData()">Show Data</button>
            
            <h4 class="mt-4">Table Data</h4>
            <div id="tableData" class="table-responsive"></div>
        </div>
    </div>
</div>

<script>
    async function fetchTables() {
        const response = await fetch('/get_tables');
        const tables = await response.json();
        populateSelect('tableSelect', tables);
        populateSelect('uploadTableSelect', tables);
        populateSelect('downloadTableSelect', tables);
    }

    function populateSelect(selectId, tables) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option selected disabled>Choose a table</option>';
        tables.forEach(table => {
            let option = document.createElement('option');
            option.value = table;
            option.textContent = table;
            select.appendChild(option);
        });
    }

    async function fetchTableData() {
        let tableName = document.getElementById('tableSelect').value;
        if (!tableName) return Swal.fire("Error", "Please select a table!", "error");

        const response = await fetch(`/show_data/${tableName}`);
        const data = await response.text();
        document.getElementById('tableData').innerHTML = data;
    }

    function downloadSample() {
        let tableName = document.getElementById('downloadTableSelect').value;
        if (!tableName) return Swal.fire("Error", "Please select a table!", "error");
        window.location.href = `/download_sample/${tableName}`;
    }

    function downloadReport(reportName) {
        window.location.href = `/download_report/${reportName}`;
    }

    fetchTables();
</script>

</body>
</html>
